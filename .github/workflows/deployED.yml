name: Build and Deploy API to EC2

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Enable corepack and install pnpm
      run: |
        corepack enable
        corepack prepare pnpm@latest --activate

    - name: Install dependencies
      run: pnpm install

    - name: Build the app
      run: pnpm run build

    - name: Prepare SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

    - name: Disable strict host key checking (optional)
      run: |
        mkdir -p ~/.ssh
        echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config

    - name: Upload dist folder to EC2 via scp
      run: |
        scp -r -i ~/.ssh/id_rsa dist/ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/app

    - name: (Optional) SSH to EC2 and restart your app
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd /home/${{ secrets.EC2_USER }}/app
          # Restart your app with pm2 or node command here, for example:
          pm2 restart your-app-name || pm2 start index.js --name your-app-name
          exit
        EOF
